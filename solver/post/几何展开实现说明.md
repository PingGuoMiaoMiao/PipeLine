# 管单元几何扫掠展开实现说明

## 概述

本模块实现了管单元中心线到三维管壳几何的展开功能，完全在后处理阶段完成，与求解器解耦。

## 实现原理

### 1. 输入数据

- **中心线节点坐标**：原始节点位置 (mm)
- **节点位移**：求解得到的节点位移 (m，转换为mm)
- **管道半径**：从截面参数中获取（外半径、内半径）

### 2. 几何生成流程

#### 2.1 节点截面生成

对每个节点，在垂直于管轴线的截面上生成 N 个环向离散点：

```python
# 生成环向角度
phis = np.linspace(0, 2 * math.pi, num_circumferential, endpoint=False)

# 对每个角度，计算截面点坐标
for phi in phis:
    R = R_base + ovalization_amp * np.cos(2 * phi)  # 考虑椭圆化
    r_local = R * (np.cos(phi) * ey + np.sin(phi) * ez)
    section_point = node_pos + r_local
```

其中：
- `R_base`: 基础半径（外半径或内半径）
- `ovalization_amp`: 椭圆化幅值（对于ELBOW290）
- `ey, ez`: 局部坐标系的环向基向量

#### 2.2 四边形面片生成

相邻节点截面之间，连接对应角度的点形成四边形面片：

```
节点1截面:  p1[0]  p1[1]  p1[2]  ...  p1[N-1]
            |      |      |            |
            |      |      |            |
节点2截面:  p2[0]  p2[1]  p2[2]  ...  p2[N-1]

四边形: [p1[i], p2[i], p2[i+1], p1[i+1]]
```

每个单元生成：
- **外表面**：`num_circumferential` 个四边形
- **内表面**：`num_circumferential` 个四边形
- **端面**：节点1和节点2各 `num_circumferential` 个四边形（连接外圆和内圆）

### 3. 局部坐标系构造

对于每个管段（节点1到节点2），构造局部坐标系：

```python
# 轴向方向
dx = node2_pos - node1_pos
ex = dx / ||dx||

# 环向方向（构造正交坐标系）
if abs(ex[2]) < 0.9:
    ey = cross(ex, [0,0,1])
else:
    ey = cross(ex, [0,1,0])
ey = ey / ||ey||

# 第三个方向
ez = cross(ex, ey)
ez = ez / ||ez||
ey = cross(ez, ex)  # 确保正交
```

### 4. 椭圆化支持

对于ELBOW290单元，支持椭圆化变形：

- 椭圆化幅值从DOF中提取（DOF 6-7：椭圆化的cos和sin项）
- 变形公式：`r(θ) = r0 + a * cos(2θ)`
- 其中 `a = sqrt(oval_cos² + oval_sin²)`

### 5. 输出格式

输出为VTK PolyData格式：

```
# vtk DataFile Version 2.0
Pipe Elements - Surface Geometry from Centerline
ASCII
DATASET POLYDATA

POINTS N double
x1 y1 z1
x2 y2 z2
...

POLYGONS M total_size
4 idx1 idx2 idx3 idx4
4 idx5 idx6 idx7 idx8
...
```

每个四边形由4个点索引定义，顺序保证法向量方向正确。

## 使用方法

### 基本用法

```python
from solver.post.vtk_writer import VTKWriter

# 求解完成后
VTKWriter.write_polylines(
    output_file,
    elements,          # 单元字典
    nodes,             # 节点字典
    displacements,     # 位移数组 (m)
    sections=parser.sections,  # 截面参数
    output_surface=True  # 输出为表面
)
```

### 参数说明

- `elements`: 单元字典，包含节点连接关系和单元类型
- `nodes`: 节点字典，包含节点坐标
- `displacements`: 全局位移数组，单位：米
- `sections`: 截面参数字典，格式：`{sec_id: {'diameter': ..., 'wall_thickness': ...}}`
- `element_section_map`: 单元到截面ID的映射（可选）
- `ovalization_dofs`: 椭圆化自由度字典（可选，用于ELBOW290）
- `output_surface`: 是否输出为表面（True）或线条（False）

## 特性

1. **完全解耦**：不依赖求解器内部实现，只基于中心线数据
2. **高效**：仅在后处理阶段生成几何，不影响求解性能
3. **灵活**：可调整环向划分点数（默认20）
4. **支持椭圆化**：自动处理ELBOW290的椭圆化变形
5. **完整几何**：生成外表面、内表面和端面

## 验证

生成的VTK文件可在ParaView中：
- 查看完整的管壳几何（而非中心线）
- 显示位移、应力等云图
- 查看椭圆化变形效果
- 进行3D旋转和缩放

