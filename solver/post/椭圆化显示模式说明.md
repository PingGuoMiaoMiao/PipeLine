# 弯管椭圆化显示模式说明

## 设计理念：显示主导、弱耦合

椭圆化处理采用"显示主导、弱耦合"模式，确保求解稳定性的同时，提供合理的可视化效果。

## 核心原则

1. **椭圆化模态不参与单元刚度矩阵**
   - ELBOW290单元的椭圆化DOF（6-7）和翘曲DOF（8-9）仅设置极小的虚拟刚度
   - 虚拟刚度的目的是保持矩阵非奇异，不影响力学计算
   - 虚拟刚度比实际刚度小6个数量级（×1e-6）

2. **椭圆化幅值在后处理阶段估计**
   - 椭圆化幅值不在求解阶段计算
   - 在VTK输出时，根据节点位移和弯矩估计椭圆化幅值
   - 支持用户指定的显示放大系数

3. **经验公式估计**
   - 基于薄壁弯管理论的简化公式
   - `A ≈ C * (M * R) / (E * t² * R_mean)`
   - 其中C为经验系数（默认0.2）

## 实现细节

### 1. 刚度矩阵处理

```python
# 在ELBOW290Element.compute_stiffness_matrix()中
# 椭圆化刚度设置为虚拟值
k_oval_virtual = E * t**3 / (R_curvature**2) * 1e-6  # 虚拟刚度
```

### 2. 椭圆化幅值估计

椭圆化幅值在 `OvalizationEstimator` 类中计算：

- `estimate_ovalization_from_moment()`: 根据弯矩估计
- `compute_moment_from_displacements()`: 从节点位移计算弯矩
- `estimate_ovalization_for_element()`: 为单元估计椭圆化幅值

### 3. 显示放大系数

用户可以通过 `ovalization_display_amplification` 参数控制椭圆化的显示强度：

- `1.0`: 真实估计值
- `> 1.0`: 放大显示（用于可视化增强）
- `< 1.0`: 缩小显示

## 使用方法

### 基本用法

```python
from solver.post.vtk_writer import VTKWriter

# 准备材料属性
material_props = {'E': 200e9, 'nu': 0.3}

# 准备单元元数据（ELBOW290需要）
element_metadata = {
    elem_id: {
        'R_curvature': elem.R_curvature,  # 曲率半径 (m)
        'L': elem.L,                      # 单元长度 (m)
        'R_mean': elem.R_mean             # 平均半径 (m)
    }
    for elem_id, elem in elbow290_elems.items()
}

# 写入VTK文件
VTKWriter.write_polylines(
    output_file,
    elements, nodes, displacements,
    sections=parser.sections,
    material_properties=material_props,
    element_metadata=element_metadata,
    ovalization_display_amplification=1.0,  # 显示放大系数
    output_surface=True
)
```

### 调整显示放大系数

```python
# 放大2倍显示
ovalization_display_amplification=2.0

# 缩小到0.5倍
ovalization_display_amplification=0.5

# 不显示椭圆化
ovalization_display_amplification=0.0
```

## 优势

1. **求解稳定性**：椭圆化模态不影响力学计算
2. **计算效率**：不在求解阶段计算椭圆化
3. **显示灵活性**：可调整显示放大系数
4. **理论合理**：基于弯矩的经验公式

## 注意事项

1. 椭圆化幅值仅为显示目的，不反映真实的力学响应
2. 经验公式的参数可能需要根据实际测试调整
3. 对于不同的弯管几何，可能需要不同的经验系数

## 未来改进

- 支持更精确的椭圆化估计公式
- 支持从用户输入读取椭圆化幅值
- 支持不同的椭圆化模式（仅椭圆化、包含翘曲等）

